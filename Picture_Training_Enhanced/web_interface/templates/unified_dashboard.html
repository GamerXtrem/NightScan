<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NightScan - Interface d'Entraînement Unifiée</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        .modality-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .modality-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .training-status {
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-active {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        .status-inactive {
            background: linear-gradient(135deg, #6c757d, #adb5bd);
            color: white;
        }
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        .progress-ring circle {
            fill: none;
            stroke: #ddd;
            stroke-width: 8;
        }
        .progress-ring .progress {
            stroke: #007bff;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-warning { background: #fff3cd; color: #856404; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-success { background: #d4edda; color: #155724; }
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .audio-theme {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .photo-theme {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-moon"></i> NightScan - Interface d'Entraînement
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#" id="systemInfo">
                    <i class="fas fa-server"></i> Système
                </a>
                <a class="nav-link" href="/comparison">
                    <i class="fas fa-chart-line"></i> Comparaison
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Overview -->
        <div class="row">
            <div class="col-12">
                <div class="training-status status-inactive" id="trainingStatus">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3><i class="fas fa-circle text-secondary"></i> Aucun entraînement actif</h3>
                            <p class="mb-0">Sélectionnez une modalité ci-dessous pour commencer l'entraînement</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-light" id="stopTraining" style="display: none;">
                                <i class="fas fa-stop"></i> Arrêter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modality Selection -->
        <div class="row" id="modalitySelection">
            <div class="col-md-6">
                <div class="card modality-card audio-theme text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-volume-up fa-4x mb-3"></i>
                        <h3>Entraînement Audio</h3>
                        <p class="mb-3">Entraînement de modèles EfficientNet sur spectrogrammes audio pour la classification des sons de faune nocturne</p>
                        <div class="row text-center">
                            <div class="col-4">
                                <strong>Modèles</strong><br>
                                <small>EfficientNet B0-B7</small>
                            </div>
                            <div class="col-4">
                                <strong>Données</strong><br>
                                <small>Spectrogrammes</small>
                            </div>
                            <div class="col-4">
                                <strong>Classes</strong><br>
                                <small>6 sons d'animaux</small>
                            </div>
                        </div>
                        <button class="btn btn-light mt-3" onclick="selectModality('audio')">
                            <i class="fas fa-play"></i> Commencer Audio
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card modality-card photo-theme text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-camera fa-4x mb-3"></i>
                        <h3>Entraînement Photo</h3>
                        <p class="mb-3">Entraînement de modèles avancés sur images pour la classification de la faune nocturne</p>
                        <div class="row text-center">
                            <div class="col-4">
                                <strong>Modèles</strong><br>
                                <small>EfficientNet, ResNet, ViT</small>
                            </div>
                            <div class="col-4">
                                <strong>Données</strong><br>
                                <small>Images RGB</small>
                            </div>
                            <div class="col-4">
                                <strong>Classes</strong><br>
                                <small>8 animaux</small>
                            </div>
                        </div>
                        <button class="btn btn-light mt-3" onclick="selectModality('photo')">
                            <i class="fas fa-play"></i> Commencer Photo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Progress -->
        <div class="row mt-4" id="trainingProgress" style="display: none;">
            <div class="col-md-8">
                <div class="metric-card">
                    <h5><i class="fas fa-chart-line"></i> Progression de l'Entraînement</h5>
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="progress-ring">
                                <svg width="120" height="120">
                                    <circle cx="60" cy="60" r="52" stroke-width="8" stroke="#ddd" fill="none"></circle>
                                    <circle cx="60" cy="60" r="52" stroke-width="8" stroke="#007bff" fill="none" 
                                            stroke-dasharray="326" stroke-dashoffset="326" class="progress" 
                                            transform="rotate(-90 60 60)"></circle>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle">
                                    <h4 id="progressPercent">0%</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Époque Actuelle</small>
                                    <h5 id="currentEpoch">0 / 0</h5>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Temps Restant</small>
                                    <h5 id="eta">--:--:--</h5>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <small class="text-muted">Perte d'Entraînement</small>
                                    <h6 id="trainLoss">0.0000</h6>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Perte de Validation</small>
                                    <h6 id="valLoss">0.0000</h6>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Précision Entraînement</small>
                                    <h6 id="trainAcc">0.00%</h6>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Précision Validation</small>
                                    <h6 id="valAcc">0.00%</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Training Charts -->
                <div class="metric-card">
                    <h5><i class="fas fa-chart-area"></i> Graphiques d'Entraînement</h5>
                    <div class="chart-container">
                        <canvas id="trainingChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="metric-card">
                    <h5><i class="fas fa-cogs"></i> Configuration</h5>
                    <div id="configDetails">
                        <p><strong>Modalité:</strong> <span id="modalityType">-</span></p>
                        <p><strong>Modèle:</strong> <span id="modelName">-</span></p>
                        <p><strong>Batch Size:</strong> <span id="batchSize">-</span></p>
                        <p><strong>Learning Rate:</strong> <span id="learningRate">-</span></p>
                        <p><strong>Époques:</strong> <span id="totalEpochs">-</span></p>
                    </div>
                </div>
                
                <div class="metric-card">
                    <h5><i class="fas fa-terminal"></i> Logs d'Entraînement</h5>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry log-info">En attente du début de l'entraînement...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configuration d'Entraînement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="trainingForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Configuration Prédéfinie</label>
                                    <select class="form-select" id="configSelect" required>
                                        <option value="">Sélectionnez une configuration</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre d'Époques</label>
                                    <input type="number" class="form-control" id="epochs" min="1" max="500" value="50">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Taille de Batch</label>
                                    <input type="number" class="form-control" id="batch_size" min="1" max="128" value="32">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Taux d'Apprentissage</label>
                                    <input type="number" class="form-control" id="learning_rate" step="0.000001" value="0.0001">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fichier CSV d'Entraînement</label>
                                    <input type="text" class="form-control" id="train_csv" placeholder="/path/to/train.csv" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fichier CSV de Validation</label>
                                    <input type="text" class="form-control" id="val_csv" placeholder="/path/to/val.csv" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <small class="text-muted">Détails de la Configuration</small>
                                </div>
                                <div class="card-body">
                                    <div id="configPreview" class="text-muted">
                                        Sélectionnez une configuration pour voir les détails
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="startTraining()">
                        <i class="fas fa-play"></i> Commencer l'Entraînement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let socket;
        let currentModality = null;
        let trainingChart;
        let trainingHistory = [];

        // Initialize Socket.IO
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                socket.emit('join_training');
            });
            
            socket.on('training_progress', function(data) {
                updateTrainingProgress(data);
            });
            
            socket.on('training_log', function(data) {
                addLogEntry(data);
            });
            
            socket.on('training_complete', function(data) {
                showTrainingComplete(data);
            });
            
            socket.on('training_status', function(data) {
                updateTrainingStatus(data);
            });
        }

        // Select modality
        function selectModality(modality) {
            currentModality = modality;
            loadConfigurations(modality);
            document.getElementById('configModal').querySelector('.modal-title').textContent = 
                `Configuration d'Entraînement ${modality === 'audio' ? 'Audio' : 'Photo'}`;
            new bootstrap.Modal(document.getElementById('configModal')).show();
        }

        // Load configurations for modality
        function loadConfigurations(modality) {
            fetch(`/api/available_configs/${modality}`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('configSelect');
                    select.innerHTML = '<option value="">Sélectionnez une configuration</option>';
                    
                    data.configs.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config;
                        option.textContent = config;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading configurations:', error);
                });
        }

        // Preview configuration
        document.getElementById('configSelect').addEventListener('change', function() {
            const configName = this.value;
            if (configName && currentModality) {
                fetch(`/api/config_details/${currentModality}/${configName}`)
                    .then(response => response.json())
                    .then(data => {
                        const preview = document.getElementById('configPreview');
                        preview.innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Architecture:</strong> ${data.config.architecture || data.config.model_name}<br>
                                    <strong>Modèle:</strong> ${data.config.model_name}<br>
                                    <strong>Optimiseur:</strong> ${data.config.optimizer}
                                </div>
                                <div class="col-md-6">
                                    <strong>Scheduler:</strong> ${data.config.scheduler}<br>
                                    <strong>Augmentation:</strong> ${data.config.use_augmentation ? 'Activée' : 'Désactivée'}<br>
                                    <strong>Précision mixte:</strong> ${data.config.mixed_precision ? 'Activée' : 'Désactivée'}
                                </div>
                            </div>
                        `;
                        
                        // Update form fields
                        document.getElementById('epochs').value = data.config.epochs;
                        document.getElementById('batch_size').value = data.config.batch_size;
                        document.getElementById('learning_rate').value = data.config.learning_rate;
                    })
                    .catch(error => {
                        console.error('Error loading config details:', error);
                    });
            }
        });

        // Start training
        function startTraining() {
            const formData = {
                modality: currentModality,
                config_name: document.getElementById('configSelect').value,
                epochs: parseInt(document.getElementById('epochs').value),
                batch_size: parseInt(document.getElementById('batch_size').value),
                learning_rate: parseFloat(document.getElementById('learning_rate').value),
                train_csv: document.getElementById('train_csv').value,
                val_csv: document.getElementById('val_csv').value
            };

            fetch('/api/start_training', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Erreur: ' + data.error);
                } else {
                    bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
                    showTrainingInterface();
                }
            })
            .catch(error => {
                console.error('Error starting training:', error);
                alert('Erreur lors du démarrage de l\'entraînement');
            });
        }

        // Show training interface
        function showTrainingInterface() {
            document.getElementById('modalitySelection').style.display = 'none';
            document.getElementById('trainingProgress').style.display = 'block';
            document.getElementById('stopTraining').style.display = 'block';
            
            // Initialize chart
            initializeTrainingChart();
            
            // Update config details
            updateConfigDetails();
        }

        // Update training progress
        function updateTrainingProgress(data) {
            // Update progress ring
            const progressPercent = data.progress_percent || 0;
            const circle = document.querySelector('.progress-ring .progress');
            const circumference = 2 * Math.PI * 52;
            const offset = circumference - (progressPercent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // Update text values
            document.getElementById('progressPercent').textContent = Math.round(progressPercent) + '%';
            document.getElementById('currentEpoch').textContent = `${data.current_epoch} / ${data.total_epochs}`;
            document.getElementById('eta').textContent = data.eta;
            document.getElementById('trainLoss').textContent = data.train_loss.toFixed(4);
            document.getElementById('valLoss').textContent = data.val_loss.toFixed(4);
            document.getElementById('trainAcc').textContent = data.train_accuracy.toFixed(2) + '%';
            document.getElementById('valAcc').textContent = data.val_accuracy.toFixed(2) + '%';
            
            // Update chart
            updateTrainingChart(data);
            
            // Update status
            const statusEl = document.getElementById('trainingStatus');
            statusEl.className = 'training-status status-active';
            statusEl.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3><i class="fas fa-circle text-success"></i> Entraînement ${currentModality} en cours</h3>
                        <p class="mb-0">Époque ${data.current_epoch}/${data.total_epochs} - ${data.eta} restant</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-outline-light" onclick="stopTraining()">
                            <i class="fas fa-stop"></i> Arrêter
                        </button>
                    </div>
                </div>
            `;
        }

        // Initialize training chart
        function initializeTrainingChart() {
            const ctx = document.getElementById('trainingChart').getContext('2d');
            trainingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Perte d\'entraînement',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Perte de validation',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update training chart
        function updateTrainingChart(data) {
            if (!trainingChart) return;
            
            trainingChart.data.labels.push(`Époque ${data.current_epoch}`);
            trainingChart.data.datasets[0].data.push(data.train_loss);
            trainingChart.data.datasets[1].data.push(data.val_loss);
            
            // Keep only last 50 points
            if (trainingChart.data.labels.length > 50) {
                trainingChart.data.labels.shift();
                trainingChart.data.datasets[0].data.shift();
                trainingChart.data.datasets[1].data.shift();
            }
            
            trainingChart.update();
        }

        // Add log entry
        function addLogEntry(data) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${data.level}`;
            logEntry.innerHTML = `<small>${new Date(data.timestamp).toLocaleTimeString()}</small> ${data.message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 100 entries
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
        }

        // Stop training
        function stopTraining() {
            if (confirm('Êtes-vous sûr de vouloir arrêter l\'entraînement ?')) {
                fetch('/api/stop_training', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Training stopped:', data);
                })
                .catch(error => {
                    console.error('Error stopping training:', error);
                });
            }
        }

        // Show training complete
        function showTrainingComplete(data) {
            const statusEl = document.getElementById('trainingStatus');
            statusEl.className = 'training-status status-inactive';
            statusEl.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3><i class="fas fa-check-circle text-success"></i> Entraînement ${data.modality} terminé</h3>
                        <p class="mb-0">L'entraînement s'est terminé avec succès</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-outline-light" onclick="resetInterface()">
                            <i class="fas fa-redo"></i> Nouveau
                        </button>
                    </div>
                </div>
            `;
        }

        // Reset interface
        function resetInterface() {
            document.getElementById('modalitySelection').style.display = 'block';
            document.getElementById('trainingProgress').style.display = 'none';
            document.getElementById('stopTraining').style.display = 'none';
            
            const statusEl = document.getElementById('trainingStatus');
            statusEl.className = 'training-status status-inactive';
            statusEl.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3><i class="fas fa-circle text-secondary"></i> Aucun entraînement actif</h3>
                        <p class="mb-0">Sélectionnez une modalité ci-dessous pour commencer l'entraînement</p>
                    </div>
                </div>
            `;
            
            // Clear logs
            document.getElementById('logContainer').innerHTML = 
                '<div class="log-entry log-info">En attente du début de l\'entraînement...</div>';
            
            // Reset chart
            if (trainingChart) {
                trainingChart.destroy();
                trainingChart = null;
            }
        }

        // Update config details
        function updateConfigDetails() {
            fetch('/api/training_status')
                .then(response => response.json())
                .then(data => {
                    if (data.config) {
                        document.getElementById('modalityType').textContent = data.modality;
                        document.getElementById('modelName').textContent = data.config.model_name;
                        document.getElementById('batchSize').textContent = data.config.batch_size;
                        document.getElementById('learningRate').textContent = data.config.learning_rate;
                        document.getElementById('totalEpochs').textContent = data.config.epochs;
                    }
                })
                .catch(error => {
                    console.error('Error loading training status:', error);
                });
        }

        // Update training status
        function updateTrainingStatus(data) {
            if (data.active) {
                currentModality = data.modality;
                showTrainingInterface();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            
            // Check if training is already active
            fetch('/api/training_status')
                .then(response => response.json())
                .then(data => {
                    if (data.active) {
                        currentModality = data.modality;
                        showTrainingInterface();
                    }
                })
                .catch(error => {
                    console.error('Error checking training status:', error);
                });
        });
    </script>
</body>
</html>